<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<!--
This is an example weekly progress report document that team members can use to report their individual progress 
of their ECE477 senior design projects. Weekly progress reports are expected to follow the general guidelines
presented in the "Progress Report Policy" document, available online at https://engineering.purdue.edu/ece477/Course/Policies/policies.html

Please create 4 copies of this example, renaming each copy to <PurdueID>.html, where <PurdueID> corresponds to
the Purdue ITAP Career Account ID given by Purdue to each individual team member. If you have any questions,
contact course staff.
-->
<html xmlns="http://www.w3.org/1999/xhtml">

<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />

	<!--Reconfigurable base tag; used to modify the site root location for root-relative links-->
	<base href="https://engineering.purdue.edu/477grp6/" />

	<!--Content-->
	<title>ECE477 Course Documents</title>
	<meta name="keywords" content="" />
	<meta name="description" content="" />
	<meta name="author" content="George Hadley">
	<meta name="format-detection" content="telephone=no" />
	<meta name="viewport" content="width=device-width,initial-scale=1.0">

	<!--CSS-->
	<link rel="stylesheet" href="css/default.css" type="text/css" media="all" />
	<link rel="stylesheet" href="css/responsive.css">
	<link rel="stylesheet" href="css/styles.css">
	<link rel="stylesheet" href="css/content.css">
	<!--[if IE 6]>
<link href="default_ie6.css" rel="stylesheet" type="text/css" />
<![endif]-->

</head>

<body>
	<div id="wrapper_site">
		<div id="wrapper_page">
			<!-- Instantiate global site header.-->
			<div id="header"></div>
			<!-- Instantiate site global navigation bar.-->
			<div id="menu"></div>

			<!-- Instantiate a page banner image. Page banner images should be 1100x350px and should be located within the local
			img folder located at this directory level. -->
			<div id="banner">
				<img src="Files/img/BannerImgExample.jpg"></img>
			</div>

			<!-- Instantiate "tools" needed for a page. Tools are premade functional blocks that can be used to build a page,
			and include things such as a file lister (for listing out homework assignments or tutorials)
		-->
			<div id="content">
				<h2>Progress Report for Peiyuan Shen</h2>

				<h4>Week 1:</h4>
				<b>Date:</b> 08-24-2018
				<br>
				<b>Total hours:</b> 5
				<br>
				<b>Description of design efforts:</b>
				<br> 
				<li>Wrote and edited the PSSCs for the project</li>
				<li>Modified the initial proposal according to the comments from the instructors</li>
				<li>Modified concept sketch of the design and the functional diagram</li>
				<li>Searched on potential components for the project and estimated the cost for the project</li>
				<br>

				<h4>Week 2:</h4>
				<b>Date:</b> 08-31-2018
				<br>
				<b>Total hours:</b> 6
				<br>
				<b>Description of design efforts:</b>
				<br> 
				<li>Created a google drive directory for the use of this project to document all the writing works and refernce documents</li>
				<li>Wrote the expected usage case, computational constraints, electronics constraints, and other constraints in Functional Specification</li>
				<li>Edited the PSSCs according to the feedback from instructors</li>
				<li>Modified the concept sketch of the design</li>
				<li>Searched the LTE module avaliable on the market. STM32L4 is the microcontroller that can work with LTE module. Details can be found <a href="https://www.st.com/en/evaluation-tools/p-l496g-cell02.html">here</a> </li>
				<br>

				<h4>Week 3:</h4>
				<b>Date:</b> 09-07-2018
				<br>
				<b>Total hours:</b> 10
				<br>
				<b>Description of design efforts:</b>
				<br>This week I searched different components that can be used for our project. Initially, we decided to have two paddles on the two sides the boat to drive the boat forward. The problem with the paddle design is that the water drug and friction faced by the paddle will be relatively high and the speed of the boat cannot be fast. After a search on the Internet with Qianli Ma, we found a <a href="https://www.youtube.com/watch?v=x10Ozo7riEY">similar project</a> shown below and it is a better solution to the project. We noticed that many RC boats use turbojet to push the boat. For a motor with high KV and large torque, the turbo can provide large power to drive the boat. Therefore, we decided to put two turbojets at the end of the boat to push the boat forward and control the heading of the boat. <br>
				<img src="Team/progress/img/peiyuan/turbojet.png" style="width:542px;height:332px; display:block; margin-left: auto; margin-right: auto">
				<br>Since we decided to take out the camera module from the microcontroller and use an out-of-box product instead, I searched online for the commercial products available. It turned out that most of the camera modules communicate through the radio at a high rate and using it requires a person to take a test and obtain a license. This complex process made our project less user-friendly. There also exists some camera modules that utilize Wi-Fi communication. Therefore, we decided to also change the communication method on the microcontroller from cellular radio data to Wi-Fi communication. We checked out the STM32F4 microcontroller and the ESP8266 Wi-Fi module, as shown in the figure below.<br>
				<img src="Team/progress/img/peiyuan/ESP8266.jpg" style="display:block; margin-left: auto; margin-right: auto">
				<br>As the result, I changed our PSSCs this week. I sent the revised version of the PSSCs to the instructors and the TA. through email and it was approved on 09/07/2018. There were mainly two changes:
				<ul>
					<li>The second PSSC was modified. The project will now utilize Wi-Fi module to communicate between the boat and the user interface on the computer instead of cellular radio data.</li>
					<li>The fourth PSSC was removed since it largely overlapped with the first and third PSSC. Initially, we were planning to send the route set by the user directly to the microcontroller and let the microcontroller to decide the directions and the rotation speed of the motors. However, we believe that the calculation is too large to be performed purely on the microcontroller and thus we decided to let the computer program do the calculation and send the rotation speed of the motors to the boat. Regardless what operating mode the user selected on the user interface, the commands sent to the boat would always contain the same kind of information. Therefore, this PSSC was removed and I proposed a new one.</li>
				</ul>
				<br>For next week, I plan to set up the GUI through Qt on the computer. There is a open-source library on <a href="https://github.com/googlemaps/google-maps-services-python">GItHub</a> that provides python API. Also, we plan to visit some parks nearby that has a lake and allows us to put the boat in it.<br><br>
			

				<h4>Week 4:</h4>
				<b>Date:</b> 09-14-2018
				<br>
				<b>Total hours:</b> 15
				<br>
				<b>Description of design efforts:</b>
				<br>This week I was mainly working on the Graphical User Interface. I used PyQt to make the GUI. The interface mainly contains a web engine for the google map interface, a GraphicsView for the camera, a GraphicsView for the compass, an info board and two tabs that switch between the two operation mode. All the components are put in some kind of Layout such that it will adjust the size in proportion to the window size. Layout stretch is used to adjust the scale of the components inside the layout. One challenging part of the GUI is to interface with the google map API. I managed to set up a web view using JavaScript and stored as HTML inside the python code in order to display the actual map. There were many problems encountered during the process since Qt5.5 deleted the web widget and created a web engine class instead. All the functions inside this class were changed and thus all the existing codes interfacing with the google map cannot execute. The way to solve this problem is to use a call back function to collect the return value of the function since the run javascript function of qt5.5 is asynchronous. In order to use the Google Map API, one must register for a API key. I got a one-year free trial and every time Google Map API was used, it would be recorded as shown below. Makers can be added by clicking on the map and the coordinates values will be reported.<br>
				
				<br>
				<div>
					<figure style="float:left">
						<img src="Team/progress/img/peiyuan/GUI1.png"
						 width="350">
						<figcaption style="text-align: center;">
							<font size="1"><i>GUI</i></font>
						</figcaption>
					</figure>
					<figure style="float:right">
						<img src="Team/progress/img/peiyuan/GUI2.png"
						 width="350">
						<figcaption style="text-align: center;">
							<font size="1"><i>GUI with working markers</i></font>
						</figcaption>
					</figure>
				</div>

				<img src="Team/progress/img/peiyuan/Coords.png"style="display:block; margin-left: auto; margin-right: auto">
				<figcaption style="text-align: center;">
					<font size="1"><i>Marker coordinates printed on the terminal</i></font>
				</figcaption>

				<br>
				
				<br>In addition, we went to find a lake for our boat to test the GPS functionality. There is a lake call lake harner in Lafayette. The coordinates of this lake is {lat: 40.450, lng: -86.870}. I set the default location for our google map interface to be this lake. 
				<br>
				<div>
					<figure style="float:left">
						<img src="Team/progress/img/peiyuan/lake1.jpg"
						 width="350">
						<figcaption style="text-align: center;">
							<font size="1"><i>lake harner</i></font>
						</figcaption>
					</figure>
					<figure style="float:right">
						<img src="Team/progress/img/peiyuan/lake2.jpg"
						 width="350">
						<figcaption style="text-align: center;">
							<font size="1"><i>lake harner</i></font>
						</figcaption>
					</figure>
				</div>
				<br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br>
				<br>For the next week, I plan to work more on the GUI and interfacing with the Google Map. I also plan to learn about some basic on how to build a boat. We are planning to build the boat body using wood and we are going to the shop to search for appropriate wood type to work on.<br><br><br>

				<h4>Week 5:</h4>
				<b>Date:</b> 09-18-2018
				<br>
				<b>Total hours:</b> 18<br>
				<br>
				<b>Description of design efforts:</b>
				<br>This week, I worked on building the boat prototype and figuring out how to use PWM to send signals to the ESC to control the speed of the motor. We went to the home depot last weekend to look for the material for prototyping the boat. As searched online for some common material used to build a boat. The material used is mostly balsa, fiberboard, basswood etc. We decided to use fiberboard because it is light and easy to work with. We can cut the board easily without using any advanced machine. We cut the board and used the hot glue gun to stick the board together as shown below. A small test on waterproofing was done shown below and it was proved that the fiberboard can be glued together to make the boat.
				<div>
					<figure style="float:left">
						<img src="Team/progress/img/peiyuan/boat.jpg"
						 width="350">
						<figcaption style="text-align: center;">
							<font size="1"><i>the boat</i></font>
						</figcaption>
					</figure>
					<figure style="float:right">
						<img src="Team/progress/img/peiyuan/water_test.jpg"
						 width="350">
						<figcaption style="text-align: center;">
							<font size="1"><i>waterproof test</i></font>
						</figcaption>
					</figure>
				</div>
				<br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br>
				<br>We were having some issue making the ESC working at the beginning of the week. With the power on and a valid PWM signal, only the fan of the ESC was working. The motor made a wired sound that does not match to any of the expected signals when connected to the power. I searched online and found an Arduino code to set up the ESC and control the speed up and down. The Arduino code worked. I measured the frequency and the duty cycle given by the Arduino and mimicked the waveform using the STM32F4. It did not work. I then realized that the voltage given from the Arduino is 5V whereas the voltage output of the STM32F4 was only 3V. I used a 2N7000 N-MOS to convert the 3V PWM to a 5V PWM with opposite duty cycle. The ESC still won’t work. The problem was that the duty cycle should increase and decrease continuously. It cannot handle a large duty cycle gap. It would stop working when suddenly change the duty cycle from 5% to 10%.<br>

				<br>For the next week, I plan to work on improving the looks of the boat, finding out ways to correctly use the ESC because for now, the initialization process has to happen at the same time when connecting the ESC to the power. I also plan to start looking at how GPS and the compass work.
				<br><br><br>

				<h4>Week 6:</h4>
				<b>Date:</b> 09-28-2018
				<br>
				<b>Total hours:</b> 20<br>
				<br>
				<b>Description of design efforts:</b>
				<br>This week, I worked on developing the Graphics User Interface, communicating with the Wi-Fi module using TCP, and configuring the GPS module.<br>
				<br>For the GUI, everytime a user clicked on the google map, a marker would be added and the latitude and the longitude would be stored. A polyline would be drawn to indicate the expected path of the boat. When right clicked on the marker, the marker would be removed from the map. All the processed related to the google map were done in Javascript and HTML and signals and channels were created to interact with the Python GUI program. The GUI also allows users to save the existing routine on the map to a file and load a file onto the map. All markers are listed on the list below the map. A compass was also added to the GUI. Every time the angle changed, the compass would update to its new position. The GUI is shown below.<br>
				<figure>
					<img src="Team/progress/img/peiyuan/GUI_week6.png" style="width:600px; display:block; margin-left: auto; margin-right: auto">
					<figcaption style="text-align: center;">
						<font size="1"><i>GUI</i></font>
					</figcaption>
				</figure>
				<br>The program can also communicate with the microcontroller through TCP to the Wi-Fi module. I used a thread to send and receive messages through TCP. The send and receive messages are printed to the terminal shown below.<br>
				<figure>
					<img src="Team/progress/img/peiyuan/tcp.png" style="width:400px; display:block; margin-left: auto; margin-right: auto">
					<figcaption style="text-align: center;">
						<font size="1"><i>TCP printouts</i></font>
					</figcaption>
				</figure>
				<br>I also worked with the GPS module. I connected the GPS with the UART module first and used PuTTY to receive the information given by the GPS module shown below. I read through the NMEA format and understand the printouts of the GPS module. The major useful information is contained in $GPGGA. I was able to extract the information on STM32F4 and saved the lat and lng given by the GPS module.<br>
				<figure>
					<img src="Team/progress/img/peiyuan/GPS.png" style="width:800px; display:block; margin-left: auto; margin-right: auto">
					<figcaption style="text-align: center;">
						<font size="1"><i>GPS info</i></font>
					</figcaption>
				</figure>
				<br>For the next week, I plan to work on letting the STM32F4 to send the GPS information through TCP and control the motor speed through the message I sent from the program.<br><br><br>

				<h4>Week 7:</h4>
				<b>Date:</b> 10-05-2018
				<br>
				<b>Total hours:</b> 20<br>
				<br>
				<b>Description of design efforts:</b>
				<br>This week, I worked on configuring GPS and Wi-Fi communication, re-setting all the pin in/out on the micro for the Qianli to draw the schematic and preparing the application materials for the Cornell Cup.

				<br>For the GPS module, I decided to extract $GPRMC, the Recommended Minimum sentence C, since it contains more desired information such as speed in knots. The information format is shown in the picture below. Initially, both the Wi-Fi and the GPS is using UART to receive one-byte data at a time. The GPS was working fine but the Wi-Fi module may omit some important information since the transfer rate can not deal with them both. The Wi-Fi has a random chance to be able to initialize. Therefore, I change the GPS UART to receive 512 bytes at a time to extract useful information appeared first and ignore the rest of the information. The GPS information is updating at a faster speed than our constraints, thus ignoring some updates will not cause any problem to our project. <br>
				<figure>
					<img src="Team/progress/img/peiyuan/GPRMC.PNG" style="display:block; margin-left: auto; margin-right: auto">
					<figcaption style="text-align: center;">
						<font size="1"><i>GPRMC</i></font>
					</figcaption>
				</figure>
				<br>I realized this week that although we have 3 ADC and each ADC has 16 channels, there are only 16 ADC channels on STM32F4 instead of 48, as what we expected before. The channel 1 of  ADC1, 2 and 3 share the same pin. The only reason having 3 ADC is to increase the sample speed, which in our case become useless. Many pins on the STM32F4 Cube default layout are already occupied by peripherals like USB which is unused but took the pin for ADC channels. I disabled all the peripherals that we are not going to use and open all the pins and peripherals that we are going to use. Many existing peripherals need to change pins to enable more peripherals to the micro. The existing codes need to be modified in order to accommodate these changes.<br>
				<figure>
					<img src="Team/progress/img/peiyuan/micro.png" style="width:700px; display:block; margin-left: auto; margin-right: auto">
					<figcaption style="text-align: center;">
						<font size="1"><i>Micro Pinout</i></font>
					</figcaption>
				</figure>
				<br>We are planning to participate in the Cornell Cup. Therefore, we are now brainstorming some potential ideas, challenges, and solutions to further improve the project. I am planning to prepare for the midterm design review next week and work on the powerpoint. I also plan to modify the current code for the micro to work with the new pin layout.
				<br><br><br>

				<h4>Week 9:</h4>
				<b>Date:</b> 10-19-2018
				<br>
				<b>Total hours:</b> 20<br>
				<br>
				<b>Description of design efforts:</b>
				<br>
				This week, I worked on rewriting the microcontroller code with the new code generated by the cube file I made last week. I separated all the codes for different modules into different files so that it is more organized and easy to debug. I opened all the peripherals and modified the ADC code such that it’s now receiving all 14 channels. I also worked with Tianjie to process the compass values read from the I2C. 

				<br>I also worked on programming the manual mode control algorithm. Since for now, our motor can only work with PWM signals that have a duty cycle ranging from 7% to 12%, the manual mode will send an integer between 7 and 12 or 0 to the microcontroller through Wi-Fi. There are five buttons on the tab: a straight, right, and left button that controls the direction of the boat; a speed up and speed down buttons that control the relative speed of the boat. When straight is pressed, the speed signal given to the boat will be equal; when the left button is pressed, the left speed signal will be smaller than the right speed than two and when the right button is pressed, the right speed signal will be smaller than the left speed signal than two. When the speed up button is pressed, both the left and the right speed signal will be increased by one and when the speed down button is pressed, both the left and the right speed signal will be decreased by one. Corner cases will also be handled. The user interface is shown in the picture below.
				<figure>
					<img src="Team/progress/img/peiyuan/manual.png" style="width:700px; display:block; margin-left: auto; margin-right: auto">
					<figcaption style="text-align: center;">
						<font size="1"><i>GUI Manual Mode</i></font>
					</figcaption>
				</figure>
				<br>Our project also passed the Round 1 of the Cornell Cup and we are accepted as a Semi-Finalist in the Cornell Cup. I plan to work more on integrate the firmware on the microcontroller and work on developing the algorithm on the GUI.
				<br><br><br>
				<h4>Week 10:</h4>
				<b>Date:</b> 10-26-2018
				<br>
				<b>Total hours:</b> 10<br>
				<br>
				<b>Description of design efforts:</b>
				<br>
				This week, I worked on researching the usage of the compass. There is a youtube video I found that is extremely useful for our case. The project was a drone with a compass, motors, GPS, etc. The design is similar to ours in the way that the components used in the project have a large overlap. Link to the video: https://www.youtube.com/watch?v=vPGChdmfKl0

				<br>It first discussed the difference between magnetic north and geographic north. The difference varies in different locations. It also talked about the interference around the sensor. Brushed DC motor and high current wiring will have a significant influence on the compass whereas the brushless DC motors have a relatively low influence. The result for brushed DC motor is shown in the figures below.
				<figure>
					<img src="Team/progress/img/peiyuan/brushed.png" style="width:700px; display:block; margin-left: auto; margin-right: auto">
					<figcaption style="text-align: center;">
						<font size="1"><i>Brushed DC Motor</i></font>
					</figcaption>
				</figure>
				<br>The algorithm for calculating the geographic north is shown in the figure below.
				<figure>
					<img src="Team/progress/img/peiyuan/compass.png" style="width:700px; display:block; margin-left: auto; margin-right: auto">
					<figcaption style="text-align: center;">
						<font size="1"><i>Compass Algorithm</i></font>
					</figcaption>
				</figure>
				<br>Calibration is important in this case because of the interference and the difference between the magnetic north and geographic north. Without the calibration, the measured values will not be a perfect circle and thus will result in inaccurate measurements. The difference displayed in the figures below.
				<figure>
					<img src="Team/progress/img/peiyuan/calibration1.png" style="width:700px; display:block; margin-left: auto; margin-right: auto">
					<figcaption style="text-align: center;">
						<font size="1"><i>With Calibration</i></font>
					</figcaption>
				</figure>
				<figure>
					<img src="Team/progress/img/peiyuan/calibration2.png" style="width:700px; display:block; margin-left: auto; margin-right: auto">
					<figcaption style="text-align: center;">
						<font size="1"><i>Without Calibration</i></font>
					</figcaption>
				</figure>
				<br>For the next week, I plan to work on integrating the firmware together. We need to have a boat ready to test in a lake before Thanksgiving. We just started prototyping our boat so I am going to make sure that we have a programmed microcontroller ready to test.<br><br><br>


			</div>

			<!-- Instantiate global footer. Any changes to the footer should be made through the top-level file "footer.html" -->
			<div id="footer"></div>
		</div>
	</div>

	<!--JS-->
	<script src="js/jquery.js"></script>
	<script src="js/jquery-migrate-1.1.1.js"></script>

	<script type="text/javascript">
		$(document).ready(function () {
			$("#header").load("header.html");
			$("#menu").load("navbar.html");
			$("#footer").load("footer.html");
		});
	</script>
</body>

</html>